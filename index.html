<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>會議邀請產生器</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 500px; margin: 0 auto; background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #222; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        input[type="text"], input[type="date"], select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 16px; background-color: #fff; }
        button { width: 100%; padding: 15px; border: none; border-radius: 5px; background-color: #FFC107; color: #333; font-size: 18px; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <h1>建立會議邀請</h1>
        <form id="eventForm">
            <div class="form-group">
                <label for="title">主旨</label>
                <input type="text" id="title" placeholder="例如：瑪卡鎷網路行銷｜網站討論" required>
            </div>
            <div class="form-group">
                <label for="date">日期</label>
                <input type="date" id="date" required>
            </div>
            <div class="form-group">
                <label for="duration">會議時長</label>
                <select id="duration">
                    <option value="30">30 分鐘</option>
                    <option value="60" selected>60 分鐘</option>
                    <option value="90">90 分鐘</option>
                    <option value="120">120 分鐘</option>
                </select>
            </div>
            <div class="form-group">
                <label for="startTime">開始時間</label>
                <select id="startTime" required></select>
            </div>
            <div class="form-group">
                <label for="location">地點 (留空則為線上會議)</label>
                <input type="text" id="location" placeholder="請輸入會議地點">
            </div>
            <button type="button" id="submitButton">建立並傳送邀請</button>
        </form>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // --- 初始化與設定 ---
            const myLiffId = "2007968447-PQ3LQjeO";
            liff.init({ liffId: myLiffId }).then(() => console.log("LIFF 初始化成功！")).catch(err => console.error("LIFF 初始化失敗", err));
            
            populateTimeOptions();
            setDefaultTime();

            document.getElementById("submitButton").addEventListener("click", createAndShareEvent);
        });

        function populateTimeOptions() {
            const startTimeSelect = document.getElementById('startTime');
            const minHour = 9;
            const maxHour = 21;

            for (let hour = minHour; hour <= maxHour; hour++) {
                for (let min of ['00', '30']) {
                    if (hour === maxHour && min !== '00') continue; // 最後只到 21:00
                    const time = ('0' + hour).slice(-2) + ':' + min;
                    const option = document.createElement('option');
                    option.value = time;
                    option.textContent = time;
                    startTimeSelect.appendChild(option);
                }
            }
        }

        function setDefaultTime() {
            const now = new Date();
            let hours = now.getHours();
            let minutes = now.getMinutes();

            if (minutes < 30) {
                minutes = 30;
            } else {
                minutes = 0;
                hours += 1;
            }
             if (hours >= 24) hours = 0;

            const defaultTime = ('0' + hours).slice(-2) + ':' + ('0' + minutes).slice(-2);
            
            // 在下拉選單中找到最接近的選項並選中它
            const startTimeSelect = document.getElementById('startTime');
            let foundOption = false;
            for (let option of startTimeSelect.options) {
                if (option.value >= defaultTime) {
                    option.selected = true;
                    foundOption = true;
                    break;
                }
            }
            if (!foundOption) { // 如果當前時間已超過最晚選項，預設選第一個
                startTimeSelect.options[0].selected = true;
            }
        }

        async function createAndShareEvent() {
            const submitButton = document.getElementById('submitButton');
            submitButton.disabled = true;
            submitButton.textContent = '處理中...';

            try {
                // --- 步驟 1: 獲取表單資料 ---
                const title = document.getElementById('title').value;
                const date = document.getElementById('date').value;
                const duration = parseInt(document.getElementById('duration').value);
                const startTime = document.getElementById('startTime').value;
                const location = document.getElementById('location').value.trim();

                const startDateTime = new Date(`${date}T${startTime}`);
                startDateTime.setMinutes(startDateTime.getMinutes() + duration);
                const endTime = ('0' + startDateTime.getHours()).slice(-2) + ':' + ('0' + startDateTime.getMinutes()).slice(-2);

                if (!title || !date || !startTime) throw new Error("請填寫主旨、日期與時間！");
                
                // --- 步驟 2: 呼叫後端 Apps Script ---
                const gasWebAppUrl = "https://script.google.com/macros/s/AKfycbw4kF7CeepBUeKPdrJUiht8lLYnY9mhxdnyLPSNlmD9TSNiMD7X1hlt1R_nMZ5lRAzp/exec";
                
                const response = await fetch(gasWebAppUrl, {
                    method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8', },
                    body: JSON.stringify({ title, date, startTime, endTime, location })
                });

                const result = await response.json();
                if (result.status !== 'success') throw new Error(`後端處理失敗: ${result.message}`);
                
                const meetingLink = result.meetingLink;
                
                // --- 步驟 3: 動態建立並分享 Flex Message ---
                if (!liff.isApiAvailable('shareTargetPicker')) throw new Error('您的 LINE 版本不支援分享功能。');
                
                const eventDate = new Date(date);
                const weekDay = ['日', '一', '二', '三', '四', '五', '六'][eventDate.getDay()];
                const formattedDate = `${eventDate.getFullYear()}/${String(eventDate.getMonth() + 1).padStart(2, '0')}/${String(eventDate.getDate()).padStart(2, '0')} (${weekDay})`;
                const displayTime = `${startTime} - ${endTime}`;

                const bodyContents = [
                    { "type": "text", "text": title, "weight": "bold", "size": "xl", "wrap": true },
                    { "type": "box", "layout": "vertical", "margin": "lg", "spacing": "sm", "contents": [
                        { "type": "separator" },
                        { "type": "box", "layout": "baseline", "spacing": "sm", "margin": "md", "contents": [
                            { "type": "text", "text": "時間", "color": "#aaaaaa", "size": "sm", "flex": 2 },
                            { "type": "text", "text": `${formattedDate}\n${displayTime}`, "color": "#666666", "size": "sm", "flex": 5, "wrap": true }
                        ]}
                    ]}
                ];

                let footerContents = [];

                if (!location && meetingLink) {
                    footerContents.push({ "type": "button", "style": "primary", "action": { "type": "uri", "label": "開啟會議連結", "uri": meetingLink }, "color": "#FFC107" });
                } else if (location) {
                    bodyContents[1].contents.push({ "type": "separator" }, { "type": "box", "layout": "baseline", "spacing": "sm", "margin": "md", "contents": [
                        { "type": "text", "text": "地點", "color": "#aaaaaa", "size": "sm", "flex": 2 },
                        { "type": "text", "text": location, "color": "#666666", "size": "sm", "flex": 5, "wrap": true }
                    ]});
                }
                
                const flexMessage = {
                    "type": "flex", "altText": `會議邀請：${title}`, "contents": {
                        "type": "bubble",
                        "header": { "type": "box", "layout": "vertical", "paddingAll": "20px", "backgroundColor": "#FFC107", "contents": [{ "type": "text", "text": "MaKarma 會議邀請函", "color": "#333333", "size": "md", "weight": "bold" }] },
                        "body": { "type": "box", "layout": "vertical", "spacing": "md", "contents": bodyContents },
                        "footer": footerContents.length > 0 ? { "type": "box", "layout": "vertical", "spacing":"sm", "contents": footerContents } : undefined
                    }
                };

                await liff.shareTargetPicker([flexMessage]);
                liff.closeWindow();

            } catch (error) {
                alert(error.message);
                console.error("發生錯誤:", error);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = '建立並傳送邀請';
            }
        }
    </script>
</body>
</html>